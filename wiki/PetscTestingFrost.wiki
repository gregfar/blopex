#summary BLOPEX Complex Petsc testing on UCAR Frost (IBM)
<wiki:toc max_depth="2" />

= Introduction =

How to test BLOPEX under Beta version of Petsc on IBM Linux system Frost.

= Setup Petsc =  

To use blopex_solve_double or blopex_solve_complex using the 
Beta release of Petsc first download the development version from 
the Petsc website at http://www.mcs.anl.gov/petsc/petsc-2/download/index.html .
 

To install files issue command:
{{{
>> gunzip -c petsc-dev.tar.gz | tar -xof -
}}}
This creates files in directory petsc-dev.  

A special config file is needed. Copy it to the petsc config directory as follows:
{{{
>> cd petsc-dev
>> cp /contrib/bgl/petsc/petsc-3.0.0-p4/bgl-ibm-goto_lapack.py config/
}}}

Now we need to install a patch for the Frost system to Petsc.
{{{
>> patch -p0 < /contrib/bgl/petsc/petsc-3.0.0-p4/petsc-3.0.0-p4.patch 
patching file ./src/sys/viewer/impls/socket/socket.h
}}}

Download the blopex_petsc_interface.tar.gz and blopex_abstract_Mar_2010.tar.gz from the Blopex Google Code site http://code.google.com/p/blopex and then move them to your home directory in Frost.

blopex_petsc_interface.tar.gz contains the changes to the blopex interface which is distributed as part Petsc.  Assuming you are in your home directory in Frost, install as follows:
{{{
>> cp blopex_petsc_interface.tar.gz petsc-dev/src/contrib/blopex/
>> cd petsc-dev/src/contrib/blopex
>> tar -zxvg blopex_petsc_interface.tar.gz
}}}

Configuration in Petsc is controlled via python scripts. The script petsc-dev/config/PETSc/packages/blopex.py contains flags to control configuration when the --download-blopex option is used.  It contains the following line (about line 15)
`self.complex    = 0`.

This specifies that the blopex interface is not defined for Petsc scalar type complex.
Edit blopex.py and change this to `self.complex    = 1`.

Without this change configuration will give the error `cannot use blopex with complex numbers it is not coded for this capability`.

Configure Petsc as follows:
{{{
>> ./config/bgl-ibm-goto_lapack.py --with-shared --with-scalar-type=complex --with-debugging=1 --download-blopex=../blopex_abstract_Mar_2010.tar.gz
 
=================================================================================
             Configuring PETSc to compile on your system                         
=================================================================================
.....
PETSc:
  **
  ** Before running "make" your PETSC_ARCH must be specified with:
  **  ** setenv PETSC_ARCH bgl-ibm-goto-O3_440d (csh/tcsh)
  **  ** PETSC_ARCH=bgl-ibm-goto-O3_440d; export PETSC_ARCH (sh/bash)
  **
  **
  ** Before running "make" your PETSC_DIR must be specified with:
  **  ** setenv PETSC_DIR /home/dmccuan/petsc-dev (csh/tcsh)
  **  ** PETSC_DIR=/home/dmccuan/petsc-dev; export PETSC_DIR (sh/b
....
}}}
Now two environment variables must be setup as specified in the configuration run. Note by default we are running under the csh shell.
{{{
>> setenv PETSC_ARCH bgl-ibm-goto-O3_440d  
>> setenv PETSC_DIR /home/dmccuan/petsc-dev
}}}

We will also need these set when compiling the blopex_petsc drivers.   

Petsc runs with either double or complex objects but not both.  
To test the blopex routines for double configure Petsc without the 
option --with-scalar-type=complex. 

After configuration is finished issue the command
{{{
>> make all test
}}}
= Setup blopex petsc drivers =  

Now create executables for the blopex drivers 
{{{
>> cd petsc-dev/src/contrib/blopex/driver
>> make driver
>> cd ../driver_fiedler
>> make driver_fiedler
}}}
 
= Execution of Tests =

See wiki PetscTestingLinux for descriptions of test programs.

Frost executes mpi jobs under the cobalt batch system.
Jobs are submitted via command cqsub.  

For example to submit driver_fiedler change to the .../blopex_petsc/driver_fiedler subdirectory and issue command:
{{{
cqsub -n 32 -t 00:10:00 ./driver_fiedler ...etc...
}}}

A batch job number is returned (say 894111).  Output is returned to current directory.
Output consists of 894111.cobaltlog, 894111.error, and 894111.output

Job execution can be monitored via command cqstat; see http://www.cisl.ucar.edu/docs/frost/cbr.jsp for details.

= Test Results =

The tests were executed on UCAR Frost system in May 2009.  This is an Linux operating system and the IBM blrts_xlc compiler was used.   

== driver_fiedler  L-matrix-complex.petsc ==

cqsub -n 32 -t 00:10:00 ./driver_fiedler -matrix L-matrix-complex.petsc -n_eigs 3 -tol 1e-6 -itr 100

Eigenvalues computed
{{{
Eigenvalue lambda       Residual              
3.2405735916818225e-06  1.9104398003429047e-07
9.4602276110268679e-06  1.5720358098795360e-07
2.0138116290393120e-05  4.9455789576037760e-07

9 iterations
Solution process, seconds: 8.418286e+01
}}}

== driver_fiedler  DL-matrix-complex.petsc ==

cqsub -n 32 -t 00:10:00 ./driver_fiedler -matrix DL-matrix-complex.petsc -n_eigs 3 -tol 1e-6 -itr 100


Eigenvalues computed
{{{
Eigenvalue lambda       Residual              
4.0146562896021974e-05  4.0097605284112998e-06
4.0189568320721522e-05  3.4396113767381132e-06
4.0221973659885288e-05  3.7112788514828566e-06

100 iterations
Solution process, seconds: 3.246532e+00
}}}

== driver_fiedler  test_complex1.petsc ==

cqsub -n 32 -t 00:10:00 ./driver_fiedler -matrix test_complex1.petsc -n_eigs 3 -tol 1e-5 -itr 20

Eigenvalues computed
{{{
Eigenvalue lambda       Residual              
9.3173086234145286e-01  2.5725883485556160e-03
9.4332184726599988e-01  1.6830353120371466e-03
9.4657160713854049e-01  4.3499844941039976e-03

20 iterations
}}}

== driver_fiedler  test_complex2.petsc ==

cqsub -n 32 -t 00:10:00 ./driver_fiedler -matrix test_complex2.petsc -n_eigs 3 -tol 1e-5 -itr 20

Eigenvalues computed
{{{
Eigenvalue lambda       Residual              
5.8390022119870444e-01  6.7837246604296915e-03
5.9280909291700978e-01  4.3844625848419149e-03
5.9577297841498866e-01  8.6492165993893883e-03

20 iterations
}}}

== driver_fiedler  test_complex3.petsc ==

cqsub -n 32 -t 00:10:00 -q debug ./driver_fiedler -matrix test_complex3.petsc -n_eigs 3 -tol 1e-5 -itr 20

Eigenvalues computed
{{{
Eigenvalue lambda       Residual              
9.6192000894983607e+01  3.9241687572818332e-02
9.6234214127818561e+01  1.0539584453860490e-01
9.6288534468695900e+01  5.5469859617371227e-02

20 iterations
Solution process, seconds: 3.407860e-01
}}}